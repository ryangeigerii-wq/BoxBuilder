<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Box Builder</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="icon" type="image/svg+xml" href="/static/img/favicon.svg?v={{ cache_bust }}" />
  <link rel="stylesheet" href="/static/css/style.css?v={{ cache_bust }}" />
  <style>
    /* Inline enhancement: active zoom button styling */
    .zoom-bar button.is-active {
      outline: 2px solid #ffd28c;
      box-shadow: 0 0 0 3px rgba(255, 210, 140, 0.35);
      filter: brightness(1.15);
      position: relative;
    }
  </style>
</head>

<body>
  <!-- Loading spinner overlay (removed shortly after JS init) -->
  <div id="builder-spinner" class="builder-spinner" aria-hidden="true">
    <div class="spinner-inner">
      <img src="/static/img/spinner/default.svg?v={{ cache_bust }}" alt="Loading" />
      <p class="spinner-text">Initializing builder…</p>
    </div>
  </div>
  <header class="site-header builder-header" style="padding:1.4rem 2rem 0.5rem;">
    <a href="/" class="back-link">← Home</a>
    <div class="logo-block builder-compact" style="margin-bottom:.5rem;">
      <img src="/static/img/logo.png?v={{ cache_bust }}" alt="Logo" class="logo" />
      <h1 style="margin:.5rem 0 0;">Box Builder</h1>
      <p class="tagline" style="margin-top:.25rem;">Interactive dimensions, volume, cutout & SVG preview.</p>
    </div>
  </header>
  <main class="builder-layout" id="lm-root"
    style="display:grid;grid-template-columns:repeat(auto-fit,minmax(380px,1fr));gap:1.25rem;align-items:start;">
    <!-- Preview panel (moved to top-right on wide screens by ordering before form when grid flows) -->
    <div class="panel preview-panel" style="order:2;">
      <h2 class="sr-only">Preview</h2>
      <div
        style="margin:.5rem 0 .8rem;display:grid;grid-template-columns:repeat(4,minmax(0,110px));justify-content:center;gap:.55rem 1rem;font-size:.7rem;">
        <button type="button" id="explodedViewBtn" class="builder-btn builder-btn--mini">Exploded</button>
        <button type="button" id="view3dBtn" class="builder-btn builder-btn--mini">Assembled</button>
        <button type="button" id="autoRotateBtn" class="builder-btn builder-btn--mini" style="display:none;">Auto
          Rotate</button>
        <button type="button" id="gridToggleBtn" class="builder-btn builder-btn--mini"
          style="display:none;">Grid</button>
        <button type="button" id="shadowToggleBtn" class="builder-btn builder-btn--mini"
          style="display:none;">Shadows</button>
        <button type="button" id="previewResetBtn" class="builder-btn builder-btn--mini"
          style="background:#2d485b;color:#fff;">Reset Preview</button>
        <div style="display:flex;flex-direction:column;align-items:center;gap:.25rem;">
          <label id="scaleSliderLabel" style="display:none;font-size:10px;">Scale: 1.0×</label>
          <input id="scaleSlider" style="display:none;width:100%;" type="range" min="0.1" max="1.0" step="0.05"
            value="1.0" />
        </div>
      </div>
      <div id="previewContainer"
        style="width:100%;height:420px;display:block;border:1px solid #ccc;border-radius:6px;background:#fff;position:relative;">
        <div id="preview3d" style="width:100%;height:100%;display:block;position:relative;"></div>
      </div>
      <!-- Combined Finish & Presets Switcher -->
      <div class="variant-preset-switch" style="margin-top:.75rem;display:flex;flex-direction:column;gap:.4rem;">
        <div class="switch-headers" role="tablist" aria-label="Finish and Presets"
          style="display:flex;gap:.6rem;align-items:center;">
          <button type="button" class="switch-btn builder-btn is-active" data-panel="finish" role="tab"
            aria-selected="true" aria-controls="switch-body" id="switch-finish-btn"
            style="flex:1;display:flex;justify-content:center;align-items:center;gap:.4rem;">Finish Variants</button>
          <button type="button" class="switch-btn builder-btn" data-panel="presets" role="tab" aria-selected="false"
            aria-controls="switch-body" id="switch-presets-btn"
            style="flex:1;display:flex;justify-content:center;align-items:center;gap:.4rem;">Box Presets</button>
        </div>
        <div id="switch-body" class="switch-body" style="position:relative;">
          <div id="finish-section" class="switch-panel panel-finish" data-panel="finish" role="tabpanel"
            aria-labelledby="switch-finish-btn"
            style="display:block;border:1px solid #253745;border-radius:6px;padding:.65rem .7rem;background:#121b22;">
            <legend style="font-size:.65rem;letter-spacing:.5px;opacity:.7;margin:0 0 .3rem;">Finish Variant Selection
            </legend>
            <input type="hidden" name="finish" value="espresso" />
            <!-- Legacy select retained (hidden) for test & backward compatibility -->
            <select name="finish" aria-hidden="true" tabindex="-1"
              style="position:absolute;left:-9999px;width:1px;height:1px;opacity:0;">
              <option value="espresso" selected>Espresso</option>
              <option value="flat">Flat</option>
              <option value="wood1">Wood1</option>
              <option value="wood2">Wood2</option>
              <option value="wood3">Wood3</option>
              <option value="light">Light</option>
              <option value="medium">Medium</option>
              <option value="dark">Dark</option>
              <option value="deep-walnut">Deep Walnut</option>
            </select>
            <div class="finish-buttons"
              style="display:grid;grid-template-columns:repeat(auto-fit,minmax(9.5rem,1fr));gap:.55rem;padding:.2rem 0 .15rem;">
              <button type="button" class="mini-btn apply-finish" data-finish="light">Light</button>
              <button type="button" class="mini-btn apply-finish" data-finish="medium">Medium</button>
              <button type="button" class="mini-btn apply-finish" data-finish="dark">Dark</button>
              <button type="button" class="mini-btn apply-finish" data-finish="deep-walnut">Deep Walnut</button>
              <button type="button" class="mini-btn apply-finish" data-finish="espresso">Espresso</button>
              <button type="button" class="mini-btn apply-finish" data-finish="flat">Flat (No Grain)</button>
              <button type="button" class="mini-btn apply-finish" data-finish="wood1">Wood Variant 1</button>
              <button type="button" class="mini-btn apply-finish" data-finish="wood2">Wood Variant 2</button>
              <button type="button" class="mini-btn apply-finish" data-finish="wood3">Wood Variant 3</button>
            </div>
            <p style="font-size:.55rem;opacity:.55;margin:.3rem 0 0;">Selecting a finish updates the 3D preview. Flat
              disables wood grain generation.</p>
          </div>
          <div class="switch-panel panel-presets" data-panel="presets" role="tabpanel"
            aria-labelledby="switch-presets-btn"
            style="display:none;border:1px solid #253745;border-radius:6px;padding:.65rem .7rem;background:#121b22;">
            <legend style="font-size:.65rem;letter-spacing:.5px;opacity:.7;margin:0 0 .3rem;">Quick Dimension Presets
            </legend>
            <div class="preset-groups" style="display:flex;flex-direction:column;gap:.75rem;">
              <div class="preset-group builtin-presets">
                <div class="preset-group-label">Built-In</div>
                <div class="preset-buttons builtin"
                  style="display:grid;grid-template-columns:repeat(auto-fit,minmax(11rem,1fr));gap:.55rem;padding:.15rem 0;">
                  <button type="button" class="mini-btn apply-preset" data-origin="builtin"
                    data-preset='{"width":20,"height":14,"depth":12,"subSize":10,"layout":"single"}'>10" Sealed
                    1.1ft³</button>
                  <button type="button" class="mini-btn apply-preset" data-origin="builtin"
                    data-preset='{"width":32,"height":16,"depth":16,"subSize":12,"layout":"single","portEnabled":1,"portType":"slot","targetHz":32}'>12"
                    Ported 2.25ft³ @32Hz</button>
                  <button type="button" class="mini-btn apply-preset" data-origin="builtin"
                    data-preset='{"width":36,"height":16,"depth":18,"subSize":12,"layout":"dual","portEnabled":1,"portType":"slot","targetHz":33}'>Dual
                    12" Ported ~4.0ft³</button>
                  <button type="button" class="mini-btn apply-preset" data-origin="builtin"
                    data-preset='{"width":24,"height":16,"depth":14,"subSize":15,"layout":"single"}'>15" Compact
                    Sealed</button>
                  <button type="button" class="mini-btn apply-preset" data-origin="builtin"
                    data-preset='{"width":40,"height":18,"depth":20,"subSize":15,"layout":"single","portEnabled":1,"portType":"slot","targetHz":31}'>15"
                    Ported Large</button>
                  <button type="button" class="mini-btn apply-preset" data-origin="builtin"
                    data-preset='{"width":18,"height":12,"depth":10,"subSize":8,"layout":"single"}'>8" Micro
                    Sealed</button>
                </div>
              </div>
              <div class="preset-group saved-presets" data-empty="1">
                <div class="preset-group-label">Saved <span class="count" style="opacity:.6;">(0)</span></div>
                <div class="preset-buttons saved"
                  style="display:grid;grid-template-columns:repeat(auto-fit,minmax(11rem,1fr));gap:.55rem;padding:.15rem 0;">
                  <!-- dynamically injected user-saved preset buttons -->
                </div>
                <div class="preset-empty-msg" style="font-size:.55rem;opacity:.5;display:block;">No saved presets yet.
                  Use "Save as Preset" after configuring.</div>
              </div>
            </div>
            <p style="font-size:.55rem;opacity:.55;margin:.35rem 0 0;">Applying a preset updates dimensions, sub
              size/count, and basic port settings (if included) without clearing undo history.</p>
          </div>
        </div>
      </div>
      <!-- Removed GLB export help text for streamlined interface -->
    </div>
    <!-- JS builder form panel (top-left) -->
    <div class="panel form-panel" style="order:1;">
      <h2 style="margin-bottom:.75rem;">Box Configuration</h2>
      <form class="box-lm-form" onsubmit="return false;">
        <!-- Top-level tabs: Subwoofer Model (new) + Box Config (existing groups) -->
        <div class="top-tabs" style="display:flex;gap:.5rem;margin-bottom:1rem;flex-wrap:wrap;">
          <button type="button" class="tab-btn builder-btn builder-btn--tab is-active" data-tab="model">Subwoofer
            Model</button>
          <button type="button" class="tab-btn builder-btn builder-btn--tab" data-tab="config">Box
            Configuration</button>
        </div>
        <!-- Tab Panels -->
        <div class="tab-panel model-panel" data-panel="model" style="display:block;margin-bottom:1.25rem;">
          <fieldset style="margin:0;color:#e2e8ec;border:1px solid #253745;padding:.75rem;border-radius:6px;">
            <legend>
              Subwoofer Model Selection</legend>
            <div style="display:flex;flex-direction:column;gap:.65rem;">
              <label style="display:flex;flex-direction:column;gap:.35rem;max-width:22rem;">
                <span class="lbl" data-tooltip="Search by brand or model name">Search Models</span>
                <input type="text" id="subModelSearch" placeholder="e.g. 12\" sub model"
                  style="padding:.45rem .55rem;border:1px solid #2f4a5c;background:#15242d;color:#e4eef3;border-radius:4px;font-size:.75rem;" />
              </label>
              <div style="display:flex;gap:.75rem;flex-wrap:wrap;align-items:flex-end;">
                <label style="display:flex;flex-direction:column;gap:.35rem;min-width:14rem;">
                  <span class="lbl">Results</span>
                  <select id="subModelResults" size="6"
                    style="padding:.4rem .5rem;border:1px solid #2f4a5c;background:#132029;color:#dbe5ea;border-radius:4px;font-size:.7rem;width:100%;min-width:14rem;">
                    <option disabled selected>Type to search…</option>
                  </select>
                </label>
                <div style="display:flex;flex-direction:column;gap:.5rem;font-size:.65rem;opacity:.7;max-width:18rem;">
                  <p style="margin:0;line-height:1.25;">Select a subwoofer model to auto-populate size and recommended
                    cut diameter. Additional specs (RMS, impedance, sensitivity) will appear below.</p>
                  <button type="button" id="subModelApplyBtn" class="action builder-btn builder-btn--primary" disabled
                    style="align-self:flex-start;">Apply
                    Model</button>
                </div>
              </div>
              <div id="subModelDetails"
                style="display:none;margin-top:.5rem;padding:.6rem .7rem;border:1px solid #253745;border-radius:6px;background:#121b22;font-size:.7rem;line-height:1.35;">
                <div style="opacity:.65;">Model details will appear here…</div>
              </div>
            </div>
          </fieldset>
        </div>
        <div class="tab-panel config-panel" data-panel="config" style="display:none;">
          <!-- Unified Config Switcher: Dimensions / Subwoofers / Port Design / Export -->
          <div class="config-switch" style="display:flex;flex-direction:column;gap:.55rem;margin-bottom:1rem;">
            <div class="config-switch-headers" role="tablist" aria-label="Box configuration sections"
              style="display:flex;flex-wrap:wrap;gap:.55rem;">
              <button type="button" class="config-switch-btn builder-btn is-active" data-panel="dimensions" role="tab"
                aria-selected="true" aria-controls="config-switch-body" id="cfg-dim-btn"
                style="flex:1;min-width:9rem;">Dimensions</button>
              <button type="button" class="config-switch-btn builder-btn" data-panel="subs" role="tab"
                aria-selected="false" aria-controls="config-switch-body" id="cfg-subs-btn"
                style="flex:1;min-width:9rem;">Subwoofers</button>
              <button type="button" class="config-switch-btn builder-btn" data-panel="port" role="tab"
                aria-selected="false" aria-controls="config-switch-body" id="cfg-port-btn"
                style="flex:1;min-width:9rem;">Port Design</button>
              <button type="button" class="config-switch-btn builder-btn" data-panel="export" role="tab"
                aria-selected="false" aria-controls="config-switch-body" id="cfg-export-btn"
                style="flex:1;min-width:9rem;">Export &amp; Actions</button>
            </div>
            <div id="config-switch-body" class="config-switch-body" style="position:relative;">
              <!-- Dimensions Panel -->
              <fieldset class="config-switch-panel" data-panel="dimensions" role="tabpanel"
                aria-labelledby="cfg-dim-btn"
                style="display:block;margin:0;color:#e2e8ec;border:1px solid #253745;border-radius:6px;padding:.7rem .75rem;background:#121b22;">
                <legend style="font-size:.65rem;letter-spacing:.5px;opacity:.7;margin:0 0 .4rem;">Exterior / Interior
                  Dimensions</legend>
                <div
                  style="display:grid;grid-template-columns:repeat(auto-fit,minmax(10rem,1fr));gap:.75rem;align-items:end;">
                  <label style="display:flex;flex-direction:column;gap:.35rem;">
                    <span class="lbl">Width (W)</span>
                    <input name="width" type="number" value="18" step="0.1" min="1" max="200" />
                  </label>
                  <label style="display:flex;flex-direction:column;gap:.35rem;">
                    <span class="lbl">Height (H)</span>
                    <input name="height" type="number" value="12" step="0.1" min="1" max="200" />
                  </label>
                  <label style="display:flex;flex-direction:column;gap:.35rem;">
                    <span class="lbl">Depth (D)</span>
                    <input name="depth" type="number" value="10" step="0.1" min="0.5" max="200" />
                  </label>
                  <label style="display:flex;flex-direction:column;gap:.35rem;">
                    <span class="lbl">Wall Thickness (in)</span>
                    <input name="wallThickness" type="number" step="0.01" min="0" value="0.75" />
                  </label>
                  <label style="display:flex;flex-direction:column;gap:.35rem;">
                    <span class="lbl">Driver Disp (in³)</span>
                    <input name="driverDisp" type="number" value="0" step="0.1" min="0" max="10000" />
                  </label>
                  <label style="display:flex;flex-direction:column;gap:.35rem;">
                    <span class="lbl">Bracing Disp (in³)</span>
                    <input name="bracingDisp" type="number" value="0" step="0.1" min="0" max="10000" />
                  </label>
                  <label style="display:flex;align-items:center;gap:.55rem;margin-top:.25rem;">
                    <input type="checkbox" name="showInternal" />
                    <span class="lbl">Show internal metrics</span>
                  </label>
                  <label style="display:flex;align-items:center;gap:.55rem;margin-top:.25rem;">
                    <input type="checkbox" name="showDims" checked />
                    <span class="lbl">Show dimension lines</span>
                  </label>
                  <label style="display:flex;align-items:center;gap:.55rem;margin-top:.25rem;">
                    <input type="checkbox" name="fillHoles" />
                    <span class="lbl">Fill Holes</span>
                  </label>
                  <label style="display:flex;align-items:center;gap:.55rem;margin-top:.25rem;">
                    <input type="checkbox" name="showCutouts" checked />
                    <span class="lbl">Show Holes</span>
                  </label>
                  <label style="display:flex;align-items:center;gap:.55rem;margin-top:.25rem;">
                    <input type="checkbox" name="hideFrontPanel" />
                    <span class="lbl">Hide Face</span>
                  </label>
                </div>
                <div class="metrics" aria-live="polite" aria-atomic="false"
                  style="margin-top:1rem;display:flex;flex-direction:column;gap:.3rem;font-size:.75rem;background:#121b22;padding:.65rem .7rem;border:1px solid #253745;border-radius:6px;">
                  <div style="opacity:.65;">Live box info appears here…</div>
                </div>
              </fieldset>
              <!-- Subwoofers Panel -->
              <fieldset class="config-switch-panel" data-panel="subs" role="tabpanel" aria-labelledby="cfg-subs-btn"
                style="display:none;margin:0;color:#e2e8ec;border:1px solid #253745;border-radius:6px;padding:.7rem .75rem;background:#121b22;">
                <legend style="font-size:.65rem;letter-spacing:.5px;opacity:.7;margin:0 0 .4rem;">Subwoofer & Holes
                </legend>
                <div
                  style="display:grid;grid-template-columns:repeat(auto-fit,minmax(9.5rem,1fr));gap:.65rem;align-items:end;">
                  <label style="display:flex;flex-direction:column;gap:.35rem;">
                    <span class="lbl">Sub Size</span>
                    <select name="subSize">
                      <option value="8">8"</option>
                      <option value="10">10"</option>
                      <option value="12" selected>12"</option>
                      <option value="15">15"</option>
                    </select>
                  </label>
                  <label style="display:flex;flex-direction:column;gap:.35rem;">
                    <span class="lbl">Sub Count</span>
                    <select name="subConfig">
                      <option value="single" selected>Single</option>
                      <option value="dual">Dual</option>
                    </select>
                  </label>
                  <label style="display:flex;flex-direction:column;gap:.35rem;">
                    <span class="lbl cut-diameter-label"
                      data-tooltip="Always verify manufacturer cutout diameter. 0.93× nominal is an estimate; use real spec if known."
                      tabindex="0">Cut Diameter (in)</span>
                    <input name="cutDiameter" type="number" value="" step="0.01" min="0" placeholder="auto" />
                  </label>
                </div>
                <div class="hole-select" style="display:none;gap:1rem;margin:.6rem 0 .4rem;">
                  <label style="display:flex;align-items:center;gap:.4rem;font-size:.7rem;">
                    <input type="radio" name="holeSelect" value="0" checked /> Hole 1
                  </label>
                  <label style="display:flex;align-items:center;gap:.4rem;font-size:.7rem;">
                    <input type="radio" name="holeSelect" value="1" /> Hole 2
                  </label>
                </div>
              </fieldset>
              <!-- Port Design Panel -->
              <fieldset class="config-switch-panel" data-panel="port" role="tabpanel" aria-labelledby="cfg-port-btn"
                style="display:none;margin:0;color:#dde3e9;border:1px solid #253745;border-radius:6px;padding:.7rem .75rem;background:#121b22;">
                <legend style="font-size:.65rem;letter-spacing:.5px;opacity:.7;margin:0 0 .4rem;">Port Design Inputs
                </legend>
                <!-- Legacy toggle button preserved for backward-compatible tests (minimal footprint) -->
                <button type="button" name="togglePortMenu"
                  style="position:absolute;right:.35rem;top:.35rem;font-size:.5rem;padding:.2rem .3rem;opacity:.35;"
                  aria-hidden="false" tabindex="0">Legacy Port Toggle</button>
                <div
                  style="display:grid;grid-template-columns:repeat(auto-fit,minmax(11rem,1fr));gap:.75rem;align-items:end;">
                  <label style="display:flex;align-items:center;gap:.5rem;margin-top:.25rem;">
                    <input type="checkbox" name="portEnabled" />
                    <span class="lbl">Enable Port</span>
                  </label>
                  <label style="display:flex;flex-direction:column;gap:.3rem;">
                    <span class="lbl">Port Type</span>
                    <select name="portType">
                      <option value="slot" selected>Slot</option>
                      <option value="round">Round</option>
                      <option value="aero">Aero (Flared)</option>
                    </select>
                  </label>
                  <label style="display:flex;flex-direction:column;gap:.3rem;">
                    <span class="lbl">Net Volume (L)</span>
                    <input name="boxVolumeLiters" type="number" min="0" step="0.1" placeholder="e.g. 65" />
                  </label>
                  <label style="display:flex;flex-direction:column;gap:.3rem;">
                    <span class="lbl">Target Tuning (Hz)</span>
                    <input name="targetHz" type="number" min="1" step="0.1" placeholder="e.g. 32" />
                  </label>
                  <label style="display:flex;flex-direction:column;gap:.3rem;">
                    <span class="lbl"># Ports</span>
                    <input name="numPorts" type="number" min="1" step="1" value="1" />
                  </label>
                  <label class="port-slot-only" style="display:flex;flex-direction:column;gap:.3rem;">
                    <span class="lbl">Slot Width (in)</span>
                    <input name="slotWidthIn" type="number" min="0" step="0.01" placeholder="e.g. 14" />
                  </label>
                  <label class="port-slot-only" style="display:flex;flex-direction:column;gap:.3rem;">
                    <span class="lbl">Slot Height (in)</span>
                    <input name="slotHeightIn" type="number" min="0" step="0.01" placeholder="e.g. 2" />
                  </label>
                  <label class="port-slot-only" style="display:flex;flex-direction:column;gap:.3rem;">
                    <span class="lbl">Slot Side</span>
                    <select name="slotSide">
                      <option value="left" selected>Left</option>
                      <option value="right">Right</option>
                    </select>
                  </label>
                  <label class="port-slot-only" style="display:flex;flex-direction:column;gap:.3rem;">
                    <span class="lbl">Slot Inset Y (in)</span>
                    <input name="slotInsetIn" type="number" step="0.01" value="0" />
                  </label>
                  <label class="port-slot-only" style="display:flex;flex-direction:column;gap:.3rem;">
                    <span class="lbl">Slot Gap (in)</span>
                    <input name="slotGapIn" type="number" min="0" step="0.01" value="0.75" />
                  </label>
                  <label class="port-round-aero" style="display:flex;flex-direction:column;gap:.3rem;">
                    <span class="lbl">Diameter (in)</span>
                    <input name="roundDiameterIn" type="number" min="0" step="0.01" placeholder="e.g. 4" />
                  </label>
                  <label class="port-round-aero" style="display:flex;flex-direction:column;gap:.3rem;">
                    <span class="lbl">Spacing (in)</span>
                    <input name="roundSpacingIn" type="number" min="0" step="0.01" value="2" />
                  </label>
                  <label class="port-round-aero" style="display:flex;flex-direction:column;gap:.3rem;">
                    <span class="lbl">Round Inset Y (in)</span>
                    <input name="roundInsetIn" type="number" step="0.01" value="0" />
                  </label>
                  <label class="port-aero-only" style="display:flex;flex-direction:column;gap:.3rem;">
                    <span class="lbl">Flare Radius (in)</span>
                    <input name="flareRadiusIn" type="number" min="0" step="0.01" value="0" />
                  </label>
                  <label class="port-slot-only" style="display:flex;flex-direction:column;gap:.3rem;">
                    <span class="lbl">Slot Height (m)</span>
                    <input name="slotHeightM" type="number" min="0" step="0.001" placeholder="e.g. 0.050" />
                  </label>
                  <label class="port-slot-only" style="display:flex;flex-direction:column;gap:.3rem;">
                    <span class="lbl">Slot Gap (m)</span>
                    <input name="slotGapM" type="number" min="0" step="0.001" value="0.010" />
                  </label>
                  <label class="port-round-aero" style="display:flex;flex-direction:column;gap:.3rem;">
                    <span class="lbl">Diameter (m)</span>
                    <input name="diameterM" type="number" min="0" step="0.001" placeholder="e.g. 0.100" />
                  </label>
                  <label class="port-aero-only" style="display:flex;flex-direction:column;gap:.3rem;">
                    <span class="lbl">Flare Radius (m)</span>
                    <input name="flareRadiusM" type="number" min="0" step="0.001" value="0" />
                  </label>
                  <label style="display:flex;align-items:center;gap:.5rem;margin-top:.25rem;">
                    <input type="checkbox" name="cornerPlacement" />
                    <span class="lbl">Corner Mouth Placement</span>
                  </label>
                  <label style="display:flex;align-items:center;gap:.5rem;margin-top:.25rem;">
                    <input type="checkbox" name="showPortOverlay" checked />
                    <span class="lbl">Show Port Overlay</span>
                  </label>
                  <label style="display:flex;flex-direction:column;gap:.3rem;">
                    <span class="lbl">Extra Physical Len (m)</span>
                    <input name="extraPhysicalLengthM" type="number" min="0" step="0.001" value="0" />
                  </label>
                  <label style="display:flex;flex-direction:column;gap:.3rem;">
                    <span class="lbl">Speed of Sound (m/s)</span>
                    <input name="speedOfSound" type="number" min="1" step="1" value="343" />
                  </label>
                  <label style="display:flex;flex-direction:column;gap:.3rem;">
                    <span class="lbl">Driver Sd (m²)</span>
                    <input name="driverSdM2" type="number" min="0" step="0.0001" placeholder="optional" />
                  </label>
                  <label style="display:flex;flex-direction:column;gap:.3rem;">
                    <span class="lbl">Peak Excursion (m)</span>
                    <input name="peakConeExcursionM" type="number" min="0" step="0.0001" placeholder="optional" />
                  </label>
                </div>
                <div style="margin-top:.75rem;display:flex;gap:.75rem;flex-wrap:wrap;">
                  <button type="button" name="computePort" class="action builder-btn builder-btn--primary">Compute
                    Port Design</button>
                  <small style="opacity:.65;">Only enter fields relevant to selected port type; others ignored. Volume
                    is
                    net internal after all displacements.</small>
                </div>
              </fieldset>
              <!-- Export & Actions Panel -->
              <fieldset class="config-switch-panel" data-panel="export" role="tabpanel" aria-labelledby="cfg-export-btn"
                style="display:none;margin:0;color:#e2e8ec;border:1px solid #253745;border-radius:6px;padding:.7rem .75rem;background:#121b22;">
                <legend style="font-size:.65rem;letter-spacing:.5px;opacity:.7;margin:0 0 .4rem;">Export &amp; Actions
                </legend>
                <div
                  style="display:grid;grid-template-columns:repeat(auto-fit,minmax(10.5rem,1fr));gap:.75rem;align-items:end;">
                  <label style="display:flex;flex-direction:column;gap:.35rem;">
                    <span class="lbl" data-tooltip="Download current 2D layout SVG (front panel view).">Front SVG</span>
                    <button type="button" class="action builder-btn builder-btn--export" name="downloadSvg">Download
                      SVG</button>
                  </label>
                  <label style="display:flex;flex-direction:column;gap:.35rem;">
                    <span class="lbl" data-tooltip="Generate GLB for 3D viewer / AR.">3D GLB</span>
                    <button type="button" class="action builder-btn builder-btn--export" name="exportGlb">Export
                      GLB</button>
                  </label>
                  <label style="display:flex;flex-direction:column;gap:.35rem;">
                    <span class="lbl" data-tooltip="Download multi-layout DXF/SVG panel sheet.">DXF / Sheet</span>
                    <button type="button" class="action builder-btn builder-btn--export" name="exportDxfSvg">Export
                      DXF/SVG</button>
                  </label>
                  <label style="display:flex;flex-direction:column;gap:.35rem;">
                    <span class="lbl" data-tooltip="Create printable PDF spec sheet.">PDF Sheet</span>
                    <button type="button" class="action builder-btn builder-btn--export" name="exportPdf">Export
                      PDF</button>
                  </label>
                  <label style="display:flex;flex-direction:column;gap:.35rem;">
                    <span class="lbl" data-tooltip="Reset all form inputs to defaults.">Reset State</span>
                    <button type="button" class="action builder-btn builder-btn--export" name="stateReset">Reset
                      State</button>
                  </label>
                </div>
                <div style="margin-top:.75rem;font-size:.65rem;opacity:.65;line-height:1.35;">
                  <p style="margin:0;">Exports reflect current dimensions, holes, port settings, and finish selection.
                    Use GLB for AR preview; DXF for fabrication layouts.</p>
                </div>
              </fieldset>
            </div>
          </div>

          <!-- Finish & Style controls now reside under Preview panel -->
  </main>
  <!-- Static fallback / SEO & enables tests to assert presence without JS execution -->
  <noscript>
    <div class="panel" style="margin:1rem;">
      <h2>Box Builder (Static Fallback)</h2>
      <p>Enable JavaScript to use the interactive box builder with live preview.</p>
    </div>
  </noscript>
  <!-- Vanilla builder script -->
  <!-- Three.js ES Module (r160+) -->
  <script
    type="module">import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js'; window.THREE = THREE;</script>
  <script src="/static/js/view_switcher.js?v={{ cache_bust }}" defer></script>
  <script src="/static/js/svg_export.js?v={{ cache_bust }}" defer></script>
  <script src="/static/js/box_builder.js?v={{ cache_bust }}" defer></script>
  <script src="/static/js/three_preview.js?v={{ cache_bust }}" defer></script>
  <script type="module" src="https://cdn.jsdelivr.net/npm/@google/model-viewer@3.3.0/dist/model-viewer.min.js"
    defer></script>
  <script type="module" src="/static/js/glb_export.js?v={{ cache_bust }}" defer></script>
  <script src="/static/js/pdf_export.js?v={{ cache_bust }}" defer></script>
  <script src="/static/js/dxf_svg_layout_export.js?v={{ cache_bust }}" defer></script>
  <!-- Removed inline camera control script referencing undefined w,h,d,controlsState to avoid early ReferenceError. -->
</body>

</html>